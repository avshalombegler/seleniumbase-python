name: GitHub Actions CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      browser:
        description: 'Browser to run tests on'
        type: choice
        options: 
          - both
          - chrome
          - firefox
        default: both
        required: true
      marker:
        description: 'Test marker to run'
        type: choice
        options:
          - smoke
          - regression
          - ui
          - api
        default: smoke
        required: true
      workers:
        description: 'Number of parallel workers'
        type: string
        default: 'auto'
        required: false
      clean_history:
        description: 'Clean all history and start fresh'
        type: boolean
        default: false
        required: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-skip:
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    steps:
      - name: Check for skip markers
        id: skip_check
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          
          if [[ "$COMMIT_MSG" == *"[skip ci]"* ]] || [[ "$COMMIT_MSG" == *"[ci skip]"* ]] || [[ "$PR_TITLE" == *"[skip ci]"* ]] || [[ "$PR_TITLE" == *"[ci skip]"* ]]; then
            echo "should_skip=true" >> $GITHUB_OUTPUT
            echo "Skipping CI due to skip marker in commit message or PR title"
          else
            echo "should_skip=false" >> $GITHUB_OUTPUT
          fi

  test:
    needs: check-skip
    if: needs.check-skip.outputs.should_skip != 'true'
    timeout-minutes: 20
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Use input if manual trigger, otherwise default to both browsers
        browser: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.browser == 'both' && fromJSON('["chrome","firefox"]') || fromJSON(format('["{0}"]', github.event.inputs.browser))) || fromJSON('["chrome","firefox"]') }}
        # Use input if manual trigger, otherwise default to smoke
        marker: ${{ github.event_name == 'workflow_dispatch' && fromJSON(format('["{0}"]', github.event.inputs.marker)) || fromJSON('["smoke"]') }}
        # Use input if manual trigger, otherwise default to auto
        workers: ${{ github.event_name == 'workflow_dispatch' && fromJSON(format('["{0}"]', github.event.inputs.workers)) || fromJSON('["auto"]') }}
    
    name: ${{ matrix.marker }} test suite - ${{ matrix.browser }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update APT package lists
        run: sudo apt-get update
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install .

      - name: Setup Chrome
        if: matrix.browser == 'chrome'
        uses: browser-actions/setup-chrome@v1

      - name: Setup Firefox
        if: matrix.browser == 'firefox'
        uses: browser-actions/setup-firefox@v1

      - name: Install Java and Allure Commandline
        run: |
          sudo apt-get install -y unzip curl openjdk-11-jre-headless
          if [ ! -d "/usr/local/allure" ]; then
            curl -L -o /tmp/allure.zip https://github.com/allure-framework/allure2/releases/download/2.35.1/allure-2.35.1.zip
            sudo unzip -q /tmp/allure.zip -d /tmp
            sudo mv /tmp/allure-2.35.1 /usr/local/allure
            sudo chmod -R +x /usr/local/allure/bin
            sudo ln -sf /usr/local/allure/bin/allure /usr/local/bin/allure
          fi

      - name: Create .env file
        run: |
          echo "BROWSER=${{ matrix.browser }}" >> .env
          echo "MAXIMIZED=False" >> .env
          echo "BASE_URL=${{ secrets.BASE_URL }}" >> .env
          echo "SHORT_TIMEOUT=3" >> .env
          echo "LONG_TIMEOUT=10" >> .env
          echo "USERNAME=${{ secrets.TEST_USERNAME }}" >> .env
          echo "PASSWORD=${{ secrets.TEST_PASSWORD }}" >> .env
          echo "GH_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> .env

      - name: Create reports directories
        run: mkdir -p reports/allure-results reports/allure-results/history

      - name: Check website availability
        run: curl -s -f ${{ secrets.BASE_URL }} > /dev/null || exit 1

      - name: Download Previous Allure History from gh-pages
        if: always() && github.event.inputs.clean_history != 'true'
        run: |
          mkdir -p reports/allure-results/history
          
          if git ls-remote --exit-code --heads origin gh-pages > /dev/null 2>&1; then
            echo "üì• Fetching history from gh-pages branch..."
            
            # Fetch the gh-pages branch
            git fetch origin gh-pages --depth=1
            
            # Use git archive to extract just the history directory
            if git show origin/gh-pages:history/${{ matrix.browser }} > /dev/null 2>&1; then
              echo "‚úÖ History directory exists, extracting files..."
              
              # Create temporary directory for extraction
              TEMP_DIR=$(mktemp -d)
              
              # Extract the entire history directory for this browser
              git archive origin/gh-pages history/${{ matrix.browser }} | tar -x -C "$TEMP_DIR"
              
              # Copy files to allure results
              if [ -d "$TEMP_DIR/history/${{ matrix.browser }}" ]; then
                cp -v "$TEMP_DIR/history/${{ matrix.browser }}"/* reports/allure-results/history/ 2>/dev/null || true
                
                HISTORY_COUNT=$(ls -1 reports/allure-results/history 2>/dev/null | wc -l)
                if [ "$HISTORY_COUNT" -gt 0 ]; then
                  echo "‚úÖ Successfully extracted $HISTORY_COUNT history files"
                  echo "üìã Sample files:"
                  ls -lh reports/allure-results/history/ | head -5
                else
                  echo "‚ö†Ô∏è  No files were copied (directory might be empty)"
                fi
              else
                echo "‚ö†Ô∏è  Directory structure unexpected after extraction"
              fi
              
              # Cleanup
              rm -rf "$TEMP_DIR"
            else
              echo "‚ÑπÔ∏è  No previous history found for ${{ matrix.browser }} (first run or new browser)"
            fi
          else
            echo "‚ÑπÔ∏è  gh-pages branch doesn't exist yet (first run)"
          fi
          
          # Always show what we have for debugging
          echo "üîç Final state of history directory:"
          ls -lh reports/allure-results/history/ 2>/dev/null || echo "  (empty or doesn't exist)"
          
      - name: Skip History Download (Clean Mode)
        if: always() && github.event.inputs.clean_history == 'true'
        run: |
          echo "üßπ CLEAN MODE: Skipping history download"
          echo "üìä This run will start fresh with no historical data"
          echo "üîç History directory status:"
          ls -lh reports/allure-results/history/ 2>/dev/null || echo "  (empty - as expected)"

      - name: Run Pytest with Allure
        continue-on-error: true
        id: pytest
        env:
          ALLURE_BUILD_NUMBER: ${{ github.run_number }}
          ALLURE_BUILD_NAME: Build ${{ github.run_number }}
        run: |
          PYTHONUNBUFFERED=1 xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" \
            pytest \
              -n ${{ matrix.workers }} --dist=loadfile \
              --browser=${{ matrix.browser }} \
              --headless \
              --alluredir=reports/allure-results \
              --reruns 3 --reruns-delay 2 \
              -m ${{ matrix.marker }}

      - name: Generate Allure Report with Accumulated History
        if: always()
        run: |
          mkdir -p reports/allure-report/${{ matrix.browser }}
          
          # Generate single report with history trends
          allure generate --clean reports/allure-results \
            -o reports/allure-report/${{ matrix.browser }}
          
          echo "‚úÖ Report generated for ${{ matrix.browser }}"

      - name: Extract Updated History for Persistence
        if: always()
        run: |
          REPORT_DIR="reports/allure-report/${{ matrix.browser }}"
          
          if [ -d "$REPORT_DIR/history" ]; then
            mkdir -p reports/history/${{ matrix.browser }}
            cp -r "$REPORT_DIR/history"/* reports/history/${{ matrix.browser }}/
            
            HISTORY_COUNT=$(ls -1 reports/history/${{ matrix.browser }} | wc -l)
            echo "‚úÖ Extracted $HISTORY_COUNT updated history files"
          else
            echo "‚ö†Ô∏è  No history directory in generated report"
          fi

      - name: Upload Allure Report for Pages Deployment
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ matrix.browser }}
          path: reports/allure-report/${{ matrix.browser }}/
          retention-days: 7
  
  deploy:
    concurrency:
      group: gh-pages-deploy
      cancel-in-progress: false
    needs: [test, check-skip]
    if: github.ref == 'refs/heads/main' && needs.check-skip.outputs.should_skip != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository (main branch for assets)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      - name: Clean gh-pages Branch (if requested)
        if: github.event.inputs.clean_history == 'true'
        run: |
          echo "üßπ CLEANING gh-pages branch - starting fresh!"
          echo "‚ö†Ô∏è  All existing test history will be deleted"
          
          # Check if gh-pages exists
          if git ls-remote --exit-code --heads origin gh-pages > /dev/null 2>&1; then
            echo "üì• Fetching current gh-pages for deletion..."
            git fetch origin gh-pages
            
            # Delete the remote branch
            git push origin --delete gh-pages
            echo "‚úÖ Deleted remote gh-pages branch"
          else
            echo "‚ÑπÔ∏è  gh-pages branch doesn't exist (nothing to clean)"
          fi
          
          # Create fresh orphan branch locally
          git checkout --orphan gh-pages
          git rm -rf . 2>/dev/null || true
          
          echo "‚úÖ Created fresh orphan gh-pages branch"
          echo "üìä Next deployment will have zero history"

      - name: Checkout gh-pages branch for history
        if: github.event.inputs.clean_history != 'true'
        run: |
          # Fetch gh-pages branch separately for history data
          if git ls-remote --exit-code --heads origin gh-pages > /dev/null 2>&1; then
            git fetch origin gh-pages:gh-pages
            git checkout gh-pages
            echo "‚úÖ Checked out gh-pages branch"
          else
            echo "üìù Creating gh-pages branch (first run)"
            git checkout --orphan gh-pages
            git rm -rf . 2>/dev/null || true
          fi

      - name: Create directory structure
        run: |
          mkdir -p reports/chrome
          mkdir -p reports/firefox
          mkdir -p history/chrome
          mkdir -p history/firefox

      - name: Download Chrome Report
        uses: actions/download-artifact@v4
        with:
          name: allure-report-chrome
          path: reports/chrome
        continue-on-error: true

      - name: Download Firefox Report
        uses: actions/download-artifact@v4
        with:
          name: allure-report-firefox
          path: reports/firefox
        continue-on-error: true

      - name: Extract and Persist History (Merge with Existing)
        if: github.event.inputs.clean_history != 'true'
        run: |
          echo "üìä Persisting history for trend analysis..."
          
          # Chrome history - merge new with existing
          if [ -d "reports/chrome/history" ] && [ -n "$(ls -A reports/chrome/history 2>/dev/null)" ]; then
            echo "üîç Chrome - New history files from this run:"
            ls -lh reports/chrome/history/
            
            # Preserve existing history files (don't overwrite)
            cp -n reports/chrome/history/* history/chrome/ 2>/dev/null || true
            
            # Update/overwrite with new files (in case of updates to existing files)
            cp -rf reports/chrome/history/* history/chrome/
            
            CHROME_COUNT=$(ls -1 history/chrome | wc -l)
            echo "‚úÖ Chrome: $CHROME_COUNT total history files (merged)"
          else
            echo "‚ö†Ô∏è  No Chrome history found in downloaded report"
          fi
          
          # Firefox history - merge new with existing
          if [ -d "reports/firefox/history" ] && [ -n "$(ls -A reports/firefox/history 2>/dev/null)" ]; then
            echo "üîç Firefox - New history files from this run:"
            ls -lh reports/firefox/history/
            
            # Preserve existing history files (don't overwrite)
            cp -n reports/firefox/history/* history/firefox/ 2>/dev/null || true
            
            # Update/overwrite with new files (in case of updates to existing files)
            cp -rf reports/firefox/history/* history/firefox/
            
            FIREFOX_COUNT=$(ls -1 history/firefox | wc -l)
            echo "‚úÖ Firefox: $FIREFOX_COUNT total history files (merged)"
          else
            echo "‚ö†Ô∏è  No Firefox history found in downloaded report"
          fi
          
          echo "üîç Final history state:"
          echo "  Chrome: $(ls -1 history/chrome 2>/dev/null | wc -l) files"
          echo "  Firefox: $(ls -1 history/firefox 2>/dev/null | wc -l) files"

      - name: Remove History from Reports (Clean Mode)
        if: github.event.inputs.clean_history == 'true'
        run: |
          echo "üßπ Removing history from reports (clean mode)"
          
          # Delete history directories from downloaded reports
          rm -rf reports/chrome/history
          rm -rf reports/firefox/history
          
          echo "‚úÖ History removed from reports"
          echo "üìä Trends will start from scratch with this run"
          
          # Verify history directories are empty
          echo "üîç Verifying history directories:"
          echo "  history/chrome: $(ls -1 history/chrome 2>/dev/null | wc -l) files"
          echo "  history/firefox: $(ls -1 history/firefox 2>/dev/null | wc -l) files"

      - name: Copy Landing Page and Assets
        env:
          BUILD_NUMBER: ${{ github.run_number }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          # Switch back to main branch to access .github/pages/
          git checkout main -- .github/pages/
          
          # Copy index.html and inject values
          if [ -f ".github/pages/index.html" ]; then
            # Generate timestamp
            export TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S')
            
            # Replace environment variables
            envsubst < .github/pages/index.html > reports/index.html
            
            echo "‚úÖ Copied and processed index.html from .github/pages/"
          else
            echo "‚ùå Error: .github/pages/index.html not found"
            exit 1
          fi
          
          # Copy favicon if it exists
          if [ -f ".github/pages/favicon.png" ]; then
            cp .github/pages/favicon.png reports/favicon.png
            echo "‚úÖ Copied favicon.png from .github/pages/"
          else
            echo "‚ö†Ô∏è  Warning: .github/pages/favicon.png not found (optional)"
          fi

      - name: Commit and Push to gh-pages
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Add all changes
          git add reports/ history/
          
          # Show what we're about to commit
          echo "üîç Files to be committed:"
          git diff --staged --stat
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è  No changes to commit"
            exit 0
          fi
          
          # Commit with detailed message
          git commit -m "üìä Update reports from build #${{ github.run_number }}" \
                     -m "Chrome history: $(ls -1 history/chrome 2>/dev/null | wc -l) files" \
                     -m "Firefox history: $(ls -1 history/firefox 2>/dev/null | wc -l) files" \
                     -m "Commit: ${{ github.sha }}" \
                     -m "Workflow: ${{ github.run_id }}"
          
          # Push with retry and proper conflict resolution
          for i in {1..5}; do
            if git push origin gh-pages; then
              echo "‚úÖ Successfully updated gh-pages on attempt $i"
              
              # Verify what was pushed
              echo "üîç Verifying committed history:"
              git ls-tree -r HEAD history/ --name-only | head -20
              
              exit 0
            else
              echo "‚ö†Ô∏è  Push failed, attempting to resolve conflicts (attempt $i/5)"
              
              # Pull with strategy to keep our history files
              git pull --rebase origin gh-pages -X ours || {
                echo "‚ùå Rebase failed, trying merge strategy"
                git rebase --abort 2>/dev/null || true
                git pull origin gh-pages --no-rebase -X ours || true
              }
              
              # Re-add our changes
              git add reports/ history/
              git commit --amend --no-edit 2>/dev/null || true
              
              sleep 2  # Brief delay before retry
            fi
          done
          
          echo "‚ùå Failed to push after 5 attempts"
          exit 1

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: reports

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4