name: GitHub Actions CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-skip:
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    steps:
      - name: Check for skip markers
        id: skip_check
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          
          if [[ "$COMMIT_MSG" == *"[skip ci]"* ]] || [[ "$COMMIT_MSG" == *"[ci skip]"* ]] || [[ "$PR_TITLE" == *"[skip ci]"* ]] || [[ "$PR_TITLE" == *"[ci skip]"* ]]; then
            echo "should_skip=true" >> $GITHUB_OUTPUT
            echo "Skipping CI due to skip marker in commit message or PR title"
          else
            echo "should_skip=false" >> $GITHUB_OUTPUT
          fi

  test:
    needs: check-skip
    if: needs.check-skip.outputs.should_skip != 'true'
    timeout-minutes: 20
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        browser: [chrome, firefox]
        workers: [auto]
        include:
          - suite: smoke
            marker: smoke
    
    name: ${{ matrix.browser }} ${{ matrix.suite }} tests
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update APT package lists
        run: sudo apt-get update
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install .

      - name: Setup Chrome
        if: matrix.browser == 'chrome'
        uses: browser-actions/setup-chrome@v1

      - name: Setup Firefox
        if: matrix.browser == 'firefox'
        uses: browser-actions/setup-firefox@v1

      - name: Install Java and Allure Commandline
        run: |
          sudo apt-get install -y unzip curl openjdk-11-jre-headless
          if [ ! -d "/usr/local/allure" ]; then
            curl -L -o /tmp/allure.zip https://github.com/allure-framework/allure2/releases/download/2.35.1/allure-2.35.1.zip
            sudo unzip -q /tmp/allure.zip -d /tmp
            sudo mv /tmp/allure-2.35.1 /usr/local/allure
            sudo chmod -R +x /usr/local/allure/bin
            sudo ln -sf /usr/local/allure/bin/allure /usr/local/bin/allure
          fi
          allure --version

      - name: Create .env file
        run: |
          echo "BROWSER=${{ matrix.browser }}" >> .env
          echo "MAXIMIZED=False" >> .env
          echo "BASE_URL=${{ secrets.BASE_URL }}" >> .env
          echo "SHORT_TIMEOUT=3" >> .env
          echo "LONG_TIMEOUT=10" >> .env
          echo "USERNAME=${{ secrets.TEST_USERNAME }}" >> .env
          echo "PASSWORD=${{ secrets.TEST_PASSWORD }}" >> .env
          echo "GH_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> .env

      - name: Create reports directories
        run: mkdir -p reports/allure-results reports/allure-results/history

      - name: Check website availability
        run: curl -s -f ${{ secrets.BASE_URL }} > /dev/null || exit 1

      - name: Download Previous Allure History from gh-pages
        if: always()
        run: |
          if git ls-remote --exit-code --heads origin gh-pages > /dev/null 2>&1; then
            echo "üì• Fetching history from gh-pages branch..."
            
            # Clone with sparse checkout for efficiency
            git clone --depth=1 --filter=blob:none --sparse \
              https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git \
              temp-gh-pages
            
            cd temp-gh-pages
            git sparse-checkout set "history/${{ matrix.browser }}"
            
            if [ -d "history/${{ matrix.browser }}" ] && [ -n "$(ls -A history/${{ matrix.browser }} 2>/dev/null)" ]; then
              cp -r "history/${{ matrix.browser }}"/* ../reports/allure-results/history/
              HISTORY_COUNT=$(ls -1 ../reports/allure-results/history | wc -l)
              echo "‚úÖ Found $HISTORY_COUNT history files"
            else
              echo "‚ÑπÔ∏è  No previous history found for ${{ matrix.browser }}"
            fi
            
            cd ..
            rm -rf temp-gh-pages
          else
            echo "‚ÑπÔ∏è  gh-pages branch doesn't exist yet (first run)"
          fi

      - name: Run Pytest with Allure
        continue-on-error: true
        id: pytest
        env:
          ALLURE_BUILD_NUMBER: ${{ github.run_number }}
          ALLURE_BUILD_NAME: Build ${{ github.run_number }}
        run: |
          PYTHONUNBUFFERED=1 xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" \
            pytest \
              -n ${{ matrix.workers }} --dist=loadfile \
              --browser=${{ matrix.browser }} \
              --headless \
              --alluredir=reports/allure-results \
              --reruns 1 --reruns-delay 2 \
              -m ${{ matrix.marker }}

      - name: Generate Allure Report with Accumulated History
        if: always()
        run: |
          mkdir -p reports/allure-report/${{ matrix.browser }}
          
          # Generate single report with history trends
          allure generate --clean reports/allure-results \
            -o reports/allure-report/${{ matrix.browser }}
          
          echo "‚úÖ Report generated for ${{ matrix.browser }}"

      - name: Extract Updated History for Persistence
        if: always()
        run: |
          REPORT_DIR="reports/allure-report/${{ matrix.browser }}"
          
          if [ -d "$REPORT_DIR/history" ]; then
            mkdir -p reports/history/${{ matrix.browser }}
            cp -r "$REPORT_DIR/history"/* reports/history/${{ matrix.browser }}/
            
            HISTORY_COUNT=$(ls -1 reports/history/${{ matrix.browser }} | wc -l)
            echo "‚úÖ Extracted $HISTORY_COUNT updated history files"
          else
            echo "‚ö†Ô∏è  No history directory in generated report"
          fi

      - name: Upload Allure Report for Pages Deployment
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ matrix.browser }}
          path: reports/allure-report/${{ matrix.browser }}/
          retention-days: 7
  
  deploy:
    concurrency:
      group: gh-pages-deploy
      cancel-in-progress: false
    needs: [test, check-skip]
    if: github.ref == 'refs/heads/main' && needs.check-skip.outputs.should_skip != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 1
        continue-on-error: true

      - name: Initialize gh-pages if needed
        run: |
          if ! git rev-parse --verify gh-pages > /dev/null 2>&1; then
            echo "üìù Creating gh-pages branch (first run)"
            git checkout --orphan gh-pages
            git rm -rf . 2>/dev/null || true
          fi

      - name: Create directory structure
        run: |
          mkdir -p reports/chrome
          mkdir -p reports/firefox
          mkdir -p history/chrome
          mkdir -p history/firefox

      - name: Download Chrome Report
        uses: actions/download-artifact@v4
        with:
          name: allure-report-chrome
          path: reports/chrome
        continue-on-error: true

      - name: Download Firefox Report
        uses: actions/download-artifact@v4
        with:
          name: allure-report-firefox
          path: reports/firefox
        continue-on-error: true

      - name: Extract and Persist History
        run: |
          echo "üìä Persisting history for trend analysis..."
          
          # Chrome history
          if [ -d "reports/chrome/history" ] && [ -n "$(ls -A reports/chrome/history 2>/dev/null)" ]; then
            cp -r reports/chrome/history/* history/chrome/
            echo "‚úÖ Chrome: $(ls -1 history/chrome | wc -l) history files"
          else
            echo "‚ö†Ô∏è  No Chrome history found"
          fi
          
          # Firefox history
          if [ -d "reports/firefox/history" ] && [ -n "$(ls -A reports/firefox/history 2>/dev/null)" ]; then
            cp -r reports/firefox/history/* history/firefox/
            echo "‚úÖ Firefox: $(ls -1 history/firefox | wc -l) history files"
          else
            echo "‚ö†Ô∏è  No Firefox history found"
          fi

      - name: Create Landing Page
        run: |
          CURRENT_DATE=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          cat > reports/index.html << EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8" />
            <title>SeleniumBase Python ‚Äì GitHub Actions Allure Reports</title>
            <link rel="icon" type="image/png" href="favicon.png" />
            <meta name="viewport" content="width=device-width, initial-scale=1" />
            <style>
              :root { color-scheme: light dark; }
              body { font-family: Arial, sans-serif; margin: 40px; }
              .browser-section { margin: 30px 0; }
              a { color: #0366d6; text-decoration: none; padding: 10px 20px; 
                  border: 1px solid #0366d6; border-radius: 4px; 
                  display: inline-block; margin: 5px; }
              a:hover { background: #0366d6; color: white; }
            </style>
          </head>
          <body>
            <h1>üß™ Test Reports - Build #${{ github.run_number }}</h1>
            <p>Generated: ${CURRENT_DATE}</p>
            
            <div class="browser-section">
              <h2>üåê Chrome</h2>
              <a href="chrome/index.html">View Report</a>
            </div>
            
            <div class="browser-section">
              <h2>ü¶ä Firefox</h2>
              <a href="firefox/index.html">View Report</a>
            </div>
            
            <hr>
            <p><small>Commit: ${{ github.sha }}</small></p>
          </body>
          </html>
          EOF

      - name: Commit and Push to gh-pages
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add reports/ history/
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è  No changes to commit"
            exit 0
          fi
          
          git commit -m "üìä Update reports from build #${{ github.run_number }}" \
                     -m "Commit: ${{ github.sha }}" \
                     -m "Workflow: ${{ github.run_id }}"
          
          # Retry push up to 3 times in case of conflicts
          for i in {1..3}; do
            if git push origin gh-pages; then
              echo "‚úÖ Successfully updated gh-pages"
              exit 0
            else
              echo "‚ö†Ô∏è  Push failed, attempting pull and retry (attempt $i/3)"
              git pull --rebase origin gh-pages || true
            fi
          done
          
          echo "‚ùå Failed to push after 3 attempts"
          exit 1

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: reports

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4